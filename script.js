var listPaysMonde = ["Afghanistan","AfriqueduSud","Aland","Albanie","Algérie","Allemagne","Andorre","Angola","Anguilla","Antarctique","Antigua-et-Barbuda","Arabie saoudite","Argentine","Arménie","Aruba","Australie","Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Biélorussie","Belgique","Belize","Bénin","Bermudes","Bhoutan","Bolivie","Bonaire","Bosnie-Herzégovine","Botswana","ÎleBouvet","Brésil","Brunei","Bulgarie","BurkinaFaso","Burundi","ÎlesCaïmans","Cambodge","Cameroun","Canada","Cap-Vert","Républiquecentrafricaine","Chili","Chine","ÎleChristmas","Chypre","ÎlesCocos","Colombie","Comores","RépubliqueduCongo","RépubliquedémocratiqueduCongo","ÎlesCook","CoréeduSud","CoréeduNord","CostaRica","CôtedIvoire","Croatie","Cuba","Curaçao","Danemark","Djibouti","Républiquedominicaine","Dominique","Égypte","Salvador","Émiratsarabesunis","Équateur","Érythrée","Espagne","Estonie","États-Unis","Éthiopie","ÎlesMalouines","ÎlesFéroé","Fidji","Finlande","France","Gabon","Gambie","Géorgie","GéorgieduSud-et-lesÎlesSandwichduSud","Ghana","Gibraltar","Grèce","Grenade","Groenland","Guadeloupe","Guam","Guatemala","Guernesey","Guinée","Guinée-Bissau","Guinéeéquatoriale","Guyana","Guyane","Haïti","ÎlesHeard-et-MacDonald","Honduras","HongKong","Hongrie","ÎledeMan","ÎlesmineureséloignéesdesÉtats-Unis","ÎlesViergesbritanniques","ÎlesViergesdesÉtats-Unis","Inde","Indonésie","Iran","Irak","Irlande","Islande","Israël","Italie","Jamaïque","Japon","Jersey","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati","Koweït","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie","Luxembourg","Macao","Macédoine","Madagascar","Malaisie","Malawi","Maldives","Mali","Malte","ÎlesMariannesduNord","Maroc","Marshall","Martinique","Maurice","Mauritanie","Mayotte","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Montserrat","Mozambique","Birmanie","Namibie","Nauru","Népal","Nicaragua","Niger","Nigeria","Niue","ÎleNorfolk","Norvège","Nouvelle-Calédonie","Nouvelle-Zélande","TerritoirebritanniquedelocéanIndien","Oman","Ouganda","Ouzbékistan","Pakistan","Palaos","AutoritéPalestinienne","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pays-Bas","Pérou","Philippines","ÎlesPitcairn","Pologne","Polynésiefrançaise","PortoRico","Portugal","Qatar","LaRéunion","Roumanie","Royaume-Uni","Russie","Rwanda","Saharaoccidental","Saint-Barthélemy","Saint-Christophe-et-Niévès","Saint-Marin","Saint-Martin","Saint-Pierre-et-Miquelon","Saint-Siège","Saint-Vincent-et-les-Grenadines","Sainte-Hélène","Sainte-Lucie","Salomon","Samoa","Samoaaméricaines","SaoTomé-et-Principe","Sénégal","Serbie","Seychelles","SierraLeone","Singapour","Slovaquie","Slovénie","Somalie","Soudan","SoudanduSud","SriLanka","Suède","Suisse","Suriname","SvalbardetÎleJanMayen","Swaziland","Syrie","Tadjikistan","Taïwan","Tanzanie","Tchad","Républiquetchèque","Terresaustralesetantarctiquesfrançaises","Thaïlande","Timororiental","Togo","Tokelau","Tonga","Trinité-et-Tobago","Tunisie","Turkménistan","ÎlesTurques-et-Caïques","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu","Venezuela","ViêtNam","Wallis-et-Futuna","Yémen","Zambie","Zimbabwe"];
var listCodePaysMonde = ["AFG","ZAF","ALA","ALB","DZA","DEU","AND","AGO","AIA","ATA","ATG","SAU","ARG","ARM","ABW","AUS","AUT","AZE","BHS","BHR","BGD","BRB","BLR","BEL","BLZ","BEN","BMU","BTN","BOL","BES","BIH","BWA","BVT","BRA","BRN","BGR","BFA","BDI","CYM","KHM","CMR","CAN","CPV","CAF","CHL","CHN","CXR","CYP","CCK","COL","COM","COG","COD","COK","KOR","PRK","CRI","CIV","HRV","CUB","CUW","DNK","DJI","DOM","DMA","EGY","SLV","ARE","ECU","ERI","ESP","EST","USA","ETH","FLK","FRO","FJI","FIN","FRA","GAB","GMB","GEO","SGS","GHA","GIB","GRC","GRD","GRL","GLP","GUM","GTM","GGY","GIN","GNB","GNQ","GUY","GUF","HTI","HMD","HND","HKG","HUN","IMN","UMI","VGB","VIR","IND","IDN","IRN","IRQ","IRL","ISL","ISR","ITA","JAM","JPN","JEY","JOR","KAZ","KEN","KGZ","KIR","KWT","LAO","LSO","LVA","LBN","LBR","LBY","LIE","LTU","LUX","MAC","MKD","MDG","MYS","MWI","MDV","MLI","MLT","MNP","MAR","MHL","MTQ","MUS","MRT","MYT","MEX","FSM","MDA","MCO","MNG","MNE","MSR","MOZ","MMR","NAM","NRU","NPL","NIC","NER","NGA","NIU","NFK","NOR","NCL","NZL","IOT","OMN","UGA","UZB","PAK","PLW","PSE","PAN","PNG","PRY","NLD","PER","PHL","PCN","POL","PYF","PRI","PRT","QAT","REU","ROU","GBR","RUS","RWA","ESH","BLM","KNA","SMR","MAF","SXM","SPM","VAT","VCT","SHN","LCA","SLB","WSM","ASM","STP","SEN","SRB","SYC","SLE","SGP","SVK","SVN","SOM","SDN","SSD","LKA","SWE","CHE","SUR","SJM","SWZ","SYR","TJK","TWN","TZA","TCD","CZE","ATF","THA","TLS","TGO","TKL","TON","TTO","TUN","TKM","TCA","TUR","TUV","UKR","URY","VUT","VEN","VNM","WLF","YEM","ZMB","ZWE"];
var correspondance = [["AFG","AF"],["ZAF","ZA"],["ALA","AX"],["ALB","AL"],["DZA","DZ"],["DEU","DE"],["AND","AD"],["AGO","AO"],["AIA","AI"],["ATA","AQ"],["ATG","AG"],["SAU","SA"],["ARG","AR"],["ARM","AM"],["ABW","AW"],["AUS","AU"],["AUT","AT"],["AZE","AZ"],["BHS","BS"],["BHR","BH"],["BGD","BD"],["BRB","BB"],["BLR","BY"],["BEL","BE"],["BLZ","BZ"],["BEN","BJ"],["BMU","BM"],["BTN","BT"],["BOL","BO"],["BES","BQ"],["BIH","BA"],["BWA","BW"],["BVT","BV"],["BRA","BR"],["BRN","BN"],["BGR","BG"],["BFA","BF"],["BDI","BI"],["CYM","KY"],["KHM","KH"],["CMR","CM"],["CAN","CA"],["CPV","CV"],["CAF","CF"],["CHL","CL"],["CHN","CN"],["CXR","CX"],["CYP","CY"],["CCK","CC"],["COL","CO"],["COM","KM"],["COG","CG"],["COD","CD"],["COK","CK"],["KOR","KR"],["PRK","KP"],["CRI","CR"],["CIV","CI"],["HRV","HR"],["CUB","CU"],["CUW","CW"],["DNK","DK"],["DJI","DJ"],["DOM","DO"],["DMA","DM"],["EGY","EG"],["SLV","SV"],["ARE","AE"],["ECU","EC"],["ERI","ER"],["ESP","ES"],["EST","EE"],["USA","US"],["ETH","ET"],["FLK","FK"],["FRO","FO"],["FJI","FJ"],["FIN","FI"],["FRA","FR"],["GAB","GA"],["GMB","GM"],["GEO","GE"],["SGS","GS"],["GHA","GH"],["GIB","GI"],["GRC","GR"],["GRD","GD"],["GRL","GL"],["GLP","GP"],["GUM","GU"],["GTM","GT"],["GGY","GG"],["GIN","GN"],["GNB","GW"],["GNQ","GQ"],["GUY","GY"],["GUF","GF"],["HTI","HT"],["HMD","HM"],["HND","HN"],["HKG","HK"],["HUN","HU"],["IMN","IM"],["UMI","UM"],["VGB","VG"],["VIR","VI"],["IND","IN"],["IDN","ID"],["IRN","IR"],["IRQ","IQ"],["IRL","IE"],["ISL","IS"],["ISR","IL"],["ITA","IT"],["JAM","JM"],["JPN","JP"],["JEY","JE"],["JOR","JO"],["KAZ","KZ"],["KEN","KE"],["KGZ","KG"],["KIR","KI"],["KWT","KW"],["LAO","LA"],["LSO","LS"],["LVA","LV"],["LBN","LB"],["LBR","LR"],["LBY","LY"],["LIE","LI"],["LTU","LT"],["LUX","LU"],["MAC","MO"],["MKD","MK"],["MDG","MG"],["MYS","MY"],["MWI","MW"],["MDV","MV"],["MLI","ML"],["MLT","MT"],["MNP","MP"],["MAR","MA"],["MHL","MH"],["MTQ","MQ"],["MUS","MU"],["MRT","MR"],["MYT","YT"],["MEX","MX"],["FSM","FM"],["MDA","MD"],["MCO","MC"],["MNG","MN"],["MNE","ME"],["MSR","MS"],["MOZ","MZ"],["MMR","MM"],["NAM","NA"],["NRU","NR"],["NPL","NP"],["NIC","NI"],["NER","NE"],["NGA","NG"],["NIU","NU"],["NFK","NF"],["NOR","NO"],["NCL","NC"],["NZL","NZ"],["IOT","IO"],["OMN","OM"],["UGA","UG"],["UZB","UZ"],["PAK","PK"],["PLW","PW"],["PSE","PS"],["PAN","PA"],["PNG","PG"],["PRY","PY"],["NLD","NL"],["PER","PE"],["PHL","PH"],["PCN","PN"],["POL","PL"],["PYF","PF"],["PRI","PR"],["PRT","PT"],["QAT","QA"],["REU","RE"],["ROU","RO"],["GBR","GB"],["RUS","RU"],["RWA","RW"],["ESH","EH"],["BLM","BL"],["KNA","KN"],["SMR","SM"],["MAF","MF"],["SXM","SX"],["SPM","PM"],["VAT","VA"],["VCT","VC"],["SHN","SH"],["LCA","LC"],["SLB","SB"],["WSM","WS"],["ASM","AS"],["STP","ST"],["SEN","SN"],["SRB","RS"],["SYC","SC"],["SLE","SL"],["SGP","SG"],["SVK","SK"],["SVN","SI"],["SOM","SO"],["SDN","SD"],["SSD","SS"],["LKA","LK"],["SWE","SE"],["CHE","CH"],["SUR","SR"],["SJM","SJ"],["SWZ","SZ"],["SYR","SY"],["TJK","TJ"],["TWN","TW"],["TZA","TZ"],["TCD","TD"],["CZE","CZ"],["ATF","TF"],["THA","TH"],["TLS","TL"],["TGO","TG"],["TKL","TK"],["TON","TO"],["TTO","TT"],["TUN","TN"],["TKM","TM"],["TCA","TC"],["TUR","TR"],["TUV","TV"],["UKR","UA"],["URY","UY"],["VUT","VU"],["VEN","VE"],["VNM","VN"],["WLF","WF"],["YEM","YE"],["ZMB","ZM"],["ZWE","ZW"]];

var map = L.map('map', {
	maxZoom: 2,
	minZoom: 2
}).setView([30, 2.3], 2);
//}).setView([46.3, 2.3], 6);

// Disable drag and zoom handlers.
map.dragging.disable();
map.touchZoom.disable();
map.doubleClickZoom.disable();
map.scrollWheelZoom.disable();
map.keyboard.disable();

/*L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
  noWrap: true
}).addTo(map);*/
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + "pk.eyJ1IjoiZGFub3UiLCJhIjoiY2lpZDFqZHR3MDBvY3Uza3MwY2lzNnQzbCJ9.Pdu0nbVuG72jr6ThvIClRQ", {
    id: 'mapbox.light',
  noWrap: true
}).addTo(map);


var svg = d3.select(map.getPanes().overlayPane).append("svg"),
  g = svg.append("g").attr("class", "leaflet-zoom-hide");

function getColor(d) {
	return d > 30  ? '#B20000' :
		   d > 25  ? '#F20000' :
		   d > 20  ? '#FF5500' :
		   d > 15  ? '#FD8700' :
		   d > 10  ? '#FDBC30' :
		   d > 5   ? '#A5C8FC' :
		   d > 1   ? '#4ABAFB' :
		   d < (-15) ? '#00014B' :
		   d < (-10) ? '#000985' :
		   d < (-5)  ? '#2036DA' :
		   d < (-1)  ? '#0676FF' :
					 '#FFFFFF' ;
}

// Je récupère les coords des pays du monde pour la map
d3.json("pays.geojson", function(error, data) {
	
	if (error) alert(error);
	
	// Je boucle sur tous les pays 
	data.features.forEach(function(d) {
		
		// Je récupère leurs infos 
		d3.json("http://api.openweathermap.org/data/2.5/weather?q="+d.properties.name+","+d.id+"&APPID=bf920662e14bbed958faa4f372a4d167", function(error, meteo) {
			if (error) alert(error);
			// Je stock les infos dans des variables pour un traitement ultérieur
			var Pluie, Nuage, IdPays, NomPays, CodePays, IdCarac, Longitude, Latitude, Main, Description, IconIcon, Base, Temperature, Pressure, Humidity , Temp_min, Temp_max, Sea_level, Grnd_level, VitesseVent, VitesseDeg;
			var dataPays = $.map(meteo, function(el) { return el });

			for(var indice1 = 0; indice1 < Object.keys(dataPays).length; indice1++){
				for(var indice2 = 0; indice2 < Object.keys(dataPays[indice1]).length; indice2++){
					var attr = Object.keys(dataPays[indice1])[indice2];
					switch(attr){
						case "lon":
							d.properties.Longitude = dataPays[indice1].lon;
							break;
						case "lat":
							d.properties.Latitude = dataPays[indice1].lat;
							break;
						case "main":
							d.properties.Main = dataPays[indice1].main;
							break;
						case "description":
							d.properties.Description = dataPays[indice1].description;
							break;
						case "temp":
							d.properties.Temperature = Math.round((dataPays[indice1].temp-273.15)*100)/100; // Conversion Kelvin vers Celcius
							break;
						case "pressure":
							d.properties.Pressure = dataPays[indice1].pressure;
							break;
						case "humidity":
							d.properties.Humidity = dataPays[indice1].humidity;
							break;
						case "temp_min":
							d.properties.Temp_min = Math.round((dataPays[indice1].temp_min-273.15)*100)/100; // Conversion Kelvin vers Celcius
							break;
						case "temp_max":
							d.properties.Temp_max = Math.round((dataPays[indice1].temp_max-273.15)*100)/100; // Conversion Kelvin vers Celcius
							break;
						case "sea_level":
							d.properties.Sea_level = dataPays[indice1].sea_level;
							break;
						case "grnd_level":
							d.properties.Grnd_level = dataPays[indice1].grnd_level;
							break;
						case "speed":
							d.properties.VitesseVent = dataPays[indice1].speed;
							break;
						case "deg":
							d.properties.VitesseDeg = dataPays[indice1].deg;
							break;
						case "all":
							d.properties.Nuage = dataPays[indice1].all;
							break;
						case "rain":
							d.properties.Pluie = dataPays[indice1].rain;
							break;
						default:
					}
				}
			}
			
			var text;
			if(d.properties.name !== undefined)
				text = " Pays :" + d.properties.name;
			if(d.properties.Latitude !== undefined)
				text = text +'<br /> Latitude : ' + d.properties.Latitude;
			if(d.properties.Longitude !== undefined)
				text = text +'<br /> Longitude : ' + d.properties.Longitude;
			if(d.properties.General !== undefined)
				text = text +'<br /> Etat du ciel : ' + d.properties.General;
			if(d.properties.temp !== undefined)
				text = text +'<br /> Météo : ' + d.properties.temp;
			if(d.properties.Temperature !== undefined)
				text = text +'<br /> Température moyenne : '+ d.properties.Temperature;
			if(d.properties.Temp_min !== undefined)
				text = text +'<br /> Température minimale : ' + d.properties.Temp_min;
			if(d.properties.Temp_max !== undefined)
				text = text +'<br /> Température maximale : ' + d.properties.Temp_max;
			if(d.properties.Pluie !== undefined)
				text = text +'<br /> Pluie : ' + d.properties.Pluie;
			if(d.properties.Nuage !== undefined)
				text = text +'<br /> Nuage : ' + d.properties.Nuage;
			if(d.properties.Sea_level !== undefined)
				text = text +'<br /> Niveau de la mer : ' + d.properties.Sea_level;
			if(d.properties.Grnd_level !== undefined)
				text = text +'<br /> Niveau du sol : ' + d.properties.Grnd_level;
			if(d.properties.VitesseVent !== undefined)
				text = text +'<br /> Vitesse du vent : ' + d.properties.VitesseVent + "m/s";
			if(d.properties.VitesseDeg !== undefined)
				text = text +'<br /> Variation : ' + d.properties.VitesseDeg;
			if(d.properties.Pressure !== undefined)
				text = text +'<br /> Pression : ' + d.properties.Pressure + "hpa";
			if(d.properties.Humidity !== undefined)
				text = text +'<br /> Humidité : ' + d.properties.Humidity + "%";	
			
			d.properties.Text = text;
			
		}); // Fin du pays// LES PROPRIETES DE MON PAYS	
	}); // Fin de tous les pays
	setTimeout(function(){
		
		var transform = d3.geo.transform({point: projectPoint}),
			path = d3.geo.path().projection(transform);
			
		// Les features et les getters			
		var feature = g.selectAll("path")
			.data(data.features)
			.enter().append("path")
			.attr("d", path)
			.classed({
			"pays": true
		})
			.style("fill", function(ccc) {
			tempe = ccc.properties.Temperature;
			switch(true){
				case (tempe >30) :
					ccc.properties.Color = '#B20000';
					return '#B20000';
				case (tempe > 25) :
					ccc.properties.Color = '#F20000';
					return '#F20000';
				case (tempe > 20) :
					ccc.properties.Color = '#FF5500';
					return '#FF5500';
				case (tempe > 15) :
					ccc.properties.Color = '#FD8700';
					return '#FD8700';
				case (tempe > 10) :
					ccc.properties.Color = '#FDBC30';
					return '#FDBC30';
				case (tempe > 5) :
					ccc.properties.Color = '#A5C8FC';
					return '#A5C8FC';
				case (tempe > 1) :
					ccc.properties.Color = '#4ABAFB';
					return '#4ABAFB';
				case (tempe < (-15)):
					ccc.properties.Color = '#00014B';
					return '#00014B';
				case (tempe < (-10)):
					ccc.properties.Color = '#000985';
					return '#000985';
				case (tempe < (-5)):
					ccc.properties.Color = '#2036DA';
					return '#2036DA';
				case (tempe < -1) :
					ccc.properties.Color = '#0676FF';
					return '#0676FF';
				case (tempe > -1) :
					ccc.properties.Color = '#0676FF';
					return '#0676FF';
				default :
					return '#FFFFFF';
			}
		})
		
		// Le reset
		map.on("viewreset", reset);
		reset();
		
		function reset() {
			var bounds = path.bounds(data),
			topLeft = bounds[0],
			bottomRight = bounds[1];

			svg.attr("width", bottomRight[0] - topLeft[0])
				.attr("height", bottomRight[1] - topLeft[1])
				.style("left", topLeft[0] + "px")
				.style("top", topLeft[1] + "px");
			g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		}
		
		// Use Leaflet to implement a D3 geometric transformation.
		function projectPoint(x, y) {
		  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
		  this.stream.point(point.x, point.y);
		}	
	}, 3000);

geoJson = L.geoJson(data, {
	style : style,
	onEachFeature: onEachFeature
}).addTo(map);


L.geoJson(data, {style: style}).addTo(map);

}); // Fin du json des pays


// Légende des couleurs en fonction des températures
var LegendTemperature = L.control({position: 'bottomright'});
LegendTemperature.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [(-15), (-10), (-5), 5, 10, 15, 20, 25, 30],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + getColor(grades[i]+1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '</br></br>' : '+');
    }

    return div;
};

LegendTemperature.addTo(map);

	
// Set du mouseover et out
function onEachFeature(feature, layer) {
	layer.on({
		mouseover: highlightFeature,
		mouseout: resetHighlight,
	});
}

// Affiche les informations du pays
function highlightFeature(e) {
	var layer = e.target;
    layer.setStyle({
        weight: 1,
        color: layer.feature.properties.Color,
        dashArray: '',
        fillOpacity: 1
    });
	info.update(e.target.feature.properties.Text, layer.feature.properties.Color);
}

// Efface les informations du pays
function resetHighlight(e) {
	info.update("");
	var layer = e.target;
    layer.setStyle({
        opacity: 1,
        weight: 0.2,
		color: layer.feature.properties.Color,
		fillOpacity: 0
    });
}

// Efface les bordures bleu par défaut
function style(feature) {
	return {
		opacity: 1,
        weight: 0.2,
		color: "black",
		fillOpacity: 0
	};
	this.infoBulle.style.color = "#777";
}


var info = L.control();

info.onAdd = function (map) {
    this.infoBulle = L.DomUtil.create('div', 'info');
    this.update();
    return this.infoBulle;
};

info.update = function (props, color) {
    this.infoBulle.innerHTML = '<h4>Information du pays : </br>' +  props + '</h4>';
	this.infoBulle.style.color = color; 
};

info.addTo(map);


//Supprime un élement du DOM
function remove(id) {
    return (elem=document.getElementById(id)).parentNode.removeChild(elem);
}

function correspondA(id){
	for(var i=0; i<correspondance.length; i++){
		var c = correspondance[i];
		if(c[1] === id)
			return c[0];
	}
}