var listPaysMonde = ["Afghanistan","AfriqueduSud","Aland","Albanie","Algérie","Allemagne","Andorre","Angola","Anguilla","Antarctique","Antigua-et-Barbuda","Arabie saoudite","Argentine","Arménie","Aruba","Australie","Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Biélorussie","Belgique","Belize","Bénin","Bermudes","Bhoutan","Bolivie","Bonaire","Bosnie-Herzégovine","Botswana","ÎleBouvet","Brésil","Brunei","Bulgarie","BurkinaFaso","Burundi","ÎlesCaïmans","Cambodge","Cameroun","Canada","Cap-Vert","Républiquecentrafricaine","Chili","Chine","ÎleChristmas","Chypre","ÎlesCocos","Colombie","Comores","RépubliqueduCongo","RépubliquedémocratiqueduCongo","ÎlesCook","CoréeduSud","CoréeduNord","CostaRica","CôtedIvoire","Croatie","Cuba","Curaçao","Danemark","Djibouti","Républiquedominicaine","Dominique","Égypte","Salvador","Émiratsarabesunis","Équateur","Érythrée","Espagne","Estonie","États-Unis","Éthiopie","ÎlesMalouines","ÎlesFéroé","Fidji","Finlande","France","Gabon","Gambie","Géorgie","GéorgieduSud-et-lesÎlesSandwichduSud","Ghana","Gibraltar","Grèce","Grenade","Groenland","Guadeloupe","Guam","Guatemala","Guernesey","Guinée","Guinée-Bissau","Guinéeéquatoriale","Guyana","Guyane","Haïti","ÎlesHeard-et-MacDonald","Honduras","HongKong","Hongrie","ÎledeMan","ÎlesmineureséloignéesdesÉtats-Unis","ÎlesViergesbritanniques","ÎlesViergesdesÉtats-Unis","Inde","Indonésie","Iran","Irak","Irlande","Islande","Israël","Italie","Jamaïque","Japon","Jersey","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati","Koweït","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie","Luxembourg","Macao","Macédoine","Madagascar","Malaisie","Malawi","Maldives","Mali","Malte","ÎlesMariannesduNord","Maroc","Marshall","Martinique","Maurice","Mauritanie","Mayotte","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Montserrat","Mozambique","Birmanie","Namibie","Nauru","Népal","Nicaragua","Niger","Nigeria","Niue","ÎleNorfolk","Norvège","Nouvelle-Calédonie","Nouvelle-Zélande","TerritoirebritanniquedelocéanIndien","Oman","Ouganda","Ouzbékistan","Pakistan","Palaos","AutoritéPalestinienne","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pays-Bas","Pérou","Philippines","ÎlesPitcairn","Pologne","Polynésiefrançaise","PortoRico","Portugal","Qatar","LaRéunion","Roumanie","Royaume-Uni","Russie","Rwanda","Saharaoccidental","Saint-Barthélemy","Saint-Christophe-et-Niévès","Saint-Marin","Saint-Martin","Saint-Pierre-et-Miquelon","Saint-Siège","Saint-Vincent-et-les-Grenadines","Sainte-Hélène","Sainte-Lucie","Salomon","Samoa","Samoaaméricaines","SaoTomé-et-Principe","Sénégal","Serbie","Seychelles","SierraLeone","Singapour","Slovaquie","Slovénie","Somalie","Soudan","SoudanduSud","SriLanka","Suède","Suisse","Suriname","SvalbardetÎleJanMayen","Swaziland","Syrie","Tadjikistan","Taïwan","Tanzanie","Tchad","Républiquetchèque","Terresaustralesetantarctiquesfrançaises","Thaïlande","Timororiental","Togo","Tokelau","Tonga","Trinité-et-Tobago","Tunisie","Turkménistan","ÎlesTurques-et-Caïques","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu","Venezuela","ViêtNam","Wallis-et-Futuna","Yémen","Zambie","Zimbabwe"];
var listCodePaysMonde = ["AFG","ZAF","ALA","ALB","DZA","DEU","AND","AGO","AIA","ATA","ATG","SAU","ARG","ARM","ABW","AUS","AUT","AZE","BHS","BHR","BGD","BRB","BLR","BEL","BLZ","BEN","BMU","BTN","BOL","BES","BIH","BWA","BVT","BRA","BRN","BGR","BFA","BDI","CYM","KHM","CMR","CAN","CPV","CAF","CHL","CHN","CXR","CYP","CCK","COL","COM","COG","COD","COK","KOR","PRK","CRI","CIV","HRV","CUB","CUW","DNK","DJI","DOM","DMA","EGY","SLV","ARE","ECU","ERI","ESP","EST","USA","ETH","FLK","FRO","FJI","FIN","FRA","GAB","GMB","GEO","SGS","GHA","GIB","GRC","GRD","GRL","GLP","GUM","GTM","GGY","GIN","GNB","GNQ","GUY","GUF","HTI","HMD","HND","HKG","HUN","IMN","UMI","VGB","VIR","IND","IDN","IRN","IRQ","IRL","ISL","ISR","ITA","JAM","JPN","JEY","JOR","KAZ","KEN","KGZ","KIR","KWT","LAO","LSO","LVA","LBN","LBR","LBY","LIE","LTU","LUX","MAC","MKD","MDG","MYS","MWI","MDV","MLI","MLT","MNP","MAR","MHL","MTQ","MUS","MRT","MYT","MEX","FSM","MDA","MCO","MNG","MNE","MSR","MOZ","MMR","NAM","NRU","NPL","NIC","NER","NGA","NIU","NFK","NOR","NCL","NZL","IOT","OMN","UGA","UZB","PAK","PLW","PSE","PAN","PNG","PRY","NLD","PER","PHL","PCN","POL","PYF","PRI","PRT","QAT","REU","ROU","GBR","RUS","RWA","ESH","BLM","KNA","SMR","MAF","SXM","SPM","VAT","VCT","SHN","LCA","SLB","WSM","ASM","STP","SEN","SRB","SYC","SLE","SGP","SVK","SVN","SOM","SDN","SSD","LKA","SWE","CHE","SUR","SJM","SWZ","SYR","TJK","TWN","TZA","TCD","CZE","ATF","THA","TLS","TGO","TKL","TON","TTO","TUN","TKM","TCA","TUR","TUV","UKR","URY","VUT","VEN","VNM","WLF","YEM","ZMB","ZWE"];
var correspondance = [["AFG","AF"],["ZAF","ZA"],["ALA","AX"],["ALB","AL"],["DZA","DZ"],["DEU","DE"],["AND","AD"],["AGO","AO"],["AIA","AI"],["ATA","AQ"],["ATG","AG"],["SAU","SA"],["ARG","AR"],["ARM","AM"],["ABW","AW"],["AUS","AU"],["AUT","AT"],["AZE","AZ"],["BHS","BS"],["BHR","BH"],["BGD","BD"],["BRB","BB"],["BLR","BY"],["BEL","BE"],["BLZ","BZ"],["BEN","BJ"],["BMU","BM"],["BTN","BT"],["BOL","BO"],["BES","BQ"],["BIH","BA"],["BWA","BW"],["BVT","BV"],["BRA","BR"],["BRN","BN"],["BGR","BG"],["BFA","BF"],["BDI","BI"],["CYM","KY"],["KHM","KH"],["CMR","CM"],["CAN","CA"],["CPV","CV"],["CAF","CF"],["CHL","CL"],["CHN","CN"],["CXR","CX"],["CYP","CY"],["CCK","CC"],["COL","CO"],["COM","KM"],["COG","CG"],["COD","CD"],["COK","CK"],["KOR","KR"],["PRK","KP"],["CRI","CR"],["CIV","CI"],["HRV","HR"],["CUB","CU"],["CUW","CW"],["DNK","DK"],["DJI","DJ"],["DOM","DO"],["DMA","DM"],["EGY","EG"],["SLV","SV"],["ARE","AE"],["ECU","EC"],["ERI","ER"],["ESP","ES"],["EST","EE"],["USA","US"],["ETH","ET"],["FLK","FK"],["FRO","FO"],["FJI","FJ"],["FIN","FI"],["FRA","FR"],["GAB","GA"],["GMB","GM"],["GEO","GE"],["SGS","GS"],["GHA","GH"],["GIB","GI"],["GRC","GR"],["GRD","GD"],["GRL","GL"],["GLP","GP"],["GUM","GU"],["GTM","GT"],["GGY","GG"],["GIN","GN"],["GNB","GW"],["GNQ","GQ"],["GUY","GY"],["GUF","GF"],["HTI","HT"],["HMD","HM"],["HND","HN"],["HKG","HK"],["HUN","HU"],["IMN","IM"],["UMI","UM"],["VGB","VG"],["VIR","VI"],["IND","IN"],["IDN","ID"],["IRN","IR"],["IRQ","IQ"],["IRL","IE"],["ISL","IS"],["ISR","IL"],["ITA","IT"],["JAM","JM"],["JPN","JP"],["JEY","JE"],["JOR","JO"],["KAZ","KZ"],["KEN","KE"],["KGZ","KG"],["KIR","KI"],["KWT","KW"],["LAO","LA"],["LSO","LS"],["LVA","LV"],["LBN","LB"],["LBR","LR"],["LBY","LY"],["LIE","LI"],["LTU","LT"],["LUX","LU"],["MAC","MO"],["MKD","MK"],["MDG","MG"],["MYS","MY"],["MWI","MW"],["MDV","MV"],["MLI","ML"],["MLT","MT"],["MNP","MP"],["MAR","MA"],["MHL","MH"],["MTQ","MQ"],["MUS","MU"],["MRT","MR"],["MYT","YT"],["MEX","MX"],["FSM","FM"],["MDA","MD"],["MCO","MC"],["MNG","MN"],["MNE","ME"],["MSR","MS"],["MOZ","MZ"],["MMR","MM"],["NAM","NA"],["NRU","NR"],["NPL","NP"],["NIC","NI"],["NER","NE"],["NGA","NG"],["NIU","NU"],["NFK","NF"],["NOR","NO"],["NCL","NC"],["NZL","NZ"],["IOT","IO"],["OMN","OM"],["UGA","UG"],["UZB","UZ"],["PAK","PK"],["PLW","PW"],["PSE","PS"],["PAN","PA"],["PNG","PG"],["PRY","PY"],["NLD","NL"],["PER","PE"],["PHL","PH"],["PCN","PN"],["POL","PL"],["PYF","PF"],["PRI","PR"],["PRT","PT"],["QAT","QA"],["REU","RE"],["ROU","RO"],["GBR","GB"],["RUS","RU"],["RWA","RW"],["ESH","EH"],["BLM","BL"],["KNA","KN"],["SMR","SM"],["MAF","MF"],["SXM","SX"],["SPM","PM"],["VAT","VA"],["VCT","VC"],["SHN","SH"],["LCA","LC"],["SLB","SB"],["WSM","WS"],["ASM","AS"],["STP","ST"],["SEN","SN"],["SRB","RS"],["SYC","SC"],["SLE","SL"],["SGP","SG"],["SVK","SK"],["SVN","SI"],["SOM","SO"],["SDN","SD"],["SSD","SS"],["LKA","LK"],["SWE","SE"],["CHE","CH"],["SUR","SR"],["SJM","SJ"],["SWZ","SZ"],["SYR","SY"],["TJK","TJ"],["TWN","TW"],["TZA","TZ"],["TCD","TD"],["CZE","CZ"],["ATF","TF"],["THA","TH"],["TLS","TL"],["TGO","TG"],["TKL","TK"],["TON","TO"],["TTO","TT"],["TUN","TN"],["TKM","TM"],["TCA","TC"],["TUR","TR"],["TUV","TV"],["UKR","UA"],["URY","UY"],["VUT","VU"],["VEN","VE"],["VNM","VN"],["WLF","WF"],["YEM","YE"],["ZMB","ZM"],["ZWE","ZW"]];
var listPaysAng = [["afghanistan"],["albania"],["algeria"],["andorra"],["angola"],["argentina"],["armenia"],["australia"],["austria"],["azerbaijan"],["bahrain"],["bangladesh"],["belarus"],["belgium"],["belize"],["bhutan"],["bolivia"],["botswana"],["brazil"],["bruneiDarussalam"],["bulgaria"],["burkinaFaso"],["burundi"],["cambodia"],["cameroon"],["canada"],["capeVerde"],["centralAfricanRepublic"],["chad"],["chile"],["china"],["colombia"],["congo"],["costaRica"],["croatia"],["cuba"],["cyprus"],["czechRepublic"],["denmark"],["djibouti"],["dominicanRepublic"],["ecuador"],["egypt"],["elSalvador"],["estonia"],["faroeIslands"],["finland"],["france2016"],["franceDepartments"],["france"],["georgia"],["germany"],["greece"],["guatemala"],["guinea"],["guyana"],["haiti"],["honduras"],["hongKong"],["hungary"],["iceland"],["india"],["indonesia"],["iran"],["iraq"],["ireland"],["israel"],["italy"],["jamaica"],["japan"],["kazakhstan"],["kenya"],["kosovo"],["kyrgyzstan"],["laos"],["latvia"],["liechtenstein"],["lithuania"],["luxembourg"],["macedonia"],["malaysia"],["mali"],["malta"],["mexico"],["moldova"],["mongolia"],["montenegro"],["myanmar"],["nepal"],["netherlands"],["newZealand"],["nicaragua"],["nigeria"],["norway"],["oman"],["pakistan"],["palestine"],["panama"],["paraguay"],["peru"],["philippines"],["poland"],["portugal"],["portugalRegions"],["puertoRico"],["qatar"],["romania"],["russia"],["rwanda"],["sanMarino"],["saudiArabia"],["serbia"],["serbiaNoKosovo"],["singapore"],["slovakia"],["slovenia"],["southAfrica"],["southKorea"],["spain"],["spainProvinces"],["sriLanka"],["suriname"],["sweden"],["switzerland"],["syria"],["taiwan"],["tajikistan"],["thailand"],["turkey"],["uganda"],["ukraine"],["unitedArabEmirates"],["unitedKingdom"],["uruguay"],["usa"],["venezuela"],["vietnam"],["yemen"]];
var infos;
var x = document.getElementById("selectPays");
var attributes = {};

var map = L.map('map', {
	maxZoom: 2,
	minZoom: 2
}).setView([0, 0], 3);

/*
map.dragging.disable();
map.touchZoom.disable();
map.doubleClickZoom.disable();
map.scrollWheelZoom.disable();
map.keyboard.disable();
*/

var svg = d3.select(map.getPanes().overlayPane).append("svg"),
	g = svg.append("g").attr("class", "leaflet-zoom-hide");
		
listPaysAng.forEach(function(d){
	var option = document.createElement("option");
	option.text = d;
	x.add(option);
});
  
var main_chart_svg = d3.select("#MaCarte")
	.append("svg")
	.attr({
		"width":800,
		"height":800
	})
	.attr("id","SVG");

function getData(Reg){
	Reg.onmouseout = function(){
		hideTooltip();
	}
	d3.json("http://api.openweathermap.org/data/2.5/weather?q="+jQuery(Reg).attr('title') + "&APPID=bf920662e14bbed958faa4f372a4d167", function(error, meteo) {

		var Pluie, Nuage, IdPays, NomPays, CodePays, IdCarac, Longitude, Latitude, Main, Description, IconIcon, Base, Temperature, Pressure, Humidity , Temp_min, Temp_max, Sea_level, Grnd_level, VitesseVent, VitesseDeg;
		var dataPays = $.map(meteo, function(el) { return el });
		for(var indice1 = 0; indice1 < Object.keys(dataPays).length; indice1++){
			for(var indice2 = 0; indice2 < Object.keys(dataPays[indice1]).length; indice2++){
				var attr = Object.keys(dataPays[indice1])[indice2];
				switch(attr){
					case "lon":
						Reg.Longitude = dataPays[indice1].lon;
						break;
					case "lat":
						Reg.Latitude = dataPays[indice1].lat;
						break;
					case "main":
						Reg.Main = dataPays[indice1].main;
						break;
					case "description":
						Reg.Description = dataPays[indice1].description;
						break;
					case "temp":
						Reg.Temperature = Math.round((dataPays[indice1].temp-273.15)*100)/100; // Conversion Kelvin vers Celcius
						break;
					case "pressure":
						Reg.Pressure = dataPays[indice1].pressure;
						break;
					case "humidity":
						Reg.Humidity = dataPays[indice1].humidity;
						break;
					case "temp_min":
						Reg.Temp_min = Math.round((dataPays[indice1].temp_min-273.15)*100)/100; // Conversion Kelvin vers Celcius
						break;
					case "temp_max":
						Reg.Temp_max = Math.round((dataPays[indice1].temp_max-273.15)*100)/100; // Conversion Kelvin vers Celcius
						break;
					case "sea_level":
						Reg.Sea_level = dataPays[indice1].sea_level;
						break;
					case "grnd_level":
						Reg.Grnd_level = dataPays[indice1].grnd_level;
						break;
					case "speed":
						Reg.VitesseVent = dataPays[indice1].speed;
						break;
					case "deg":
						Reg.VitesseDeg = dataPays[indice1].deg;
						break;
					case "all":
						Reg.Nuage = dataPays[indice1].all;
						break;
					case "rain":
						Reg.Pluie = dataPays[indice1].rain;
						break;
					default:
				}
			}
		}
	
		var text = "";
		if(Reg.Latitude !== undefined)
			text = text +'<br /> Latitude : ' + Reg.Latitude;
		if(Reg.Longitude !== undefined)
			text = text +'<br /> Longitude : ' + Reg.Longitude;
		if(Reg.General !== undefined)
			text = text +'<br /> Etat du ciel : ' + Reg.General;
		if(Reg.temp !== undefined)
			text = text +'<br /> Météo : ' + Reg.temp;
		if(Reg.Temperature !== undefined)
			text = text +'<br /> Température moyenne : '+ Reg.Temperature;
		if(Reg.Temp_min !== undefined)
			text = text +'<br /> Température minimale : ' + Reg.Temp_min;
		if(Reg.Temp_max !== undefined)
			text = text +'<br /> Température maximale : ' + Reg.Temp_max;
		if(Reg.Pluie !== undefined)
			text = text +'<br /> Pluie : ' + Reg.Pluie;
		if(Reg.Nuage !== undefined)
			text = text +'<br /> Nuage : ' + Reg.Nuage;
		if(Reg.Sea_level !== undefined)
			text = text +'<br /> Niveau de la mer : ' + Reg.Sea_level;
		if(Reg.Grnd_level !== undefined)
			text = text +'<br /> Niveau du sol : ' + Reg.Grnd_level;
		if(Reg.VitesseVent !== undefined)
			text = text +'<br /> Vitesse du vent : ' + Reg.VitesseVent + "m/s";
		if(Reg.VitesseDeg !== undefined)
			text = text +'<br /> Variation : ' + Reg.VitesseDeg;
		if(Reg.Pressure !== undefined)
			text = text +'<br /> Pression : ' + Reg.Pressure + "hpa";
		if(Reg.Humidity !== undefined)
			text = text +'<br /> Humidité : ' + Reg.Humidity + "%";	
		Reg.text = text;
		Reg.style.fill = getColor(Reg.Temperature);
	});

	Reg.onmouseover = function(){
		displayTooltip(jQuery(this).attr('title') + '<br/>' + this.text);
	}
}
		
function changementSelect(sel){
	d3.xml("../countries/maps/"+sel.value+"High ().svg", function(error, documentFragment) {

		d3.select("#carte").remove();
		if (error) {console.log(error); return;}
				
		var svgNode = documentFragment.getElementsByTagName("svg")[0];
		svgNode.id = "carte";
		
		var svgNode2 = documentFragment.getElementsByTagName("amcharts:ammap")[0];
		var lon = (parseFloat(jQuery(svgNode2).attr('leftLongitude')) + parseFloat(jQuery(svgNode2).attr('rightLongitude')))/2;
		var lat = (parseFloat(jQuery(svgNode2).attr('topLatitude')) + parseFloat(jQuery(svgNode2).attr('bottomLatitude')))/2;
		
		pathList = documentFragment.getElementsByTagName("path");
		for (Reg of pathList){
			getData(Reg);
		}
		map.getPanes().overlayPane.appendChild(documentFragment.documentElement);
		map.setView(new L.LatLng(lon, lat), 2);
	});	
	
}

function getColor(d) {
	return d > 30  ? '#B20000' :
		   d > 25  ? '#F20000' :
		   d > 20  ? '#FF5500' :
		   d > 15  ? '#FD8700' :
		   d > 10  ? '#FDBC30' :
		   d > 5   ? '#A5C8FC' :
		   d > 1   ? '#4ABAFB' :
		   d < (-15) ? '#00014B' :
		   d < (-10) ? '#000985' :
		   d < (-5)  ? '#2036DA' :
		   d < (-1)  ? '#0676FF' :
					 '#FFFFFF' ;
}


// Légende des couleurs en fonction des températures

var LegendTemperature = L.control({position: 'bottomright'});
LegendTemperature.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [(-15), (-10), (-5), 5, 10, 15, 20, 25, 30],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + getColor(grades[i]+1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '</br></br>' : '+');
    }

    return div;
};

LegendTemperature.addTo(map);

// Set du mouseover et out
function onEachFeature(feature, layer) {
	layer.on({
		mouseover: highlightFeature,
		mouseout: resetHighlight,
	});
}

// Affiche les informations du pays
function highlightFeature(e) {
	var layer = e.target;
    layer.setStyle({
        weight: 1,
        color: layer.feature.properties.Color,
        dashArray: '',
        fillOpacity: 1
    });
	info.update(e.target.feature.properties.Text, layer.feature.properties.Color);
}

// Efface les informations du pays
function resetHighlight(e) {
	info.update("");
	var layer = e.target;
    layer.setStyle({
        opacity: 1,
        weight: 0.2,
		color: layer.feature.properties.Color,
		fillOpacity: 0
    });
}

// Efface les bordures bleu par défaut
function style(feature) {
	return {
		opacity: 1,
        weight: 0.2,
		color: "black",
		fillOpacity: 0
	};
	this.infoBulle.style.color = "#777";
}


var info = L.control();

info.onAdd = function (map) {
    this.infoBulle = L.DomUtil.create('div', 'info');
    this.update();
    return this.infoBulle;
};

info.update = function (props, color) {
    this.infoBulle.innerHTML = '<h4>Information de la région : </br>' +  props + '</h4>';
	this.infoBulle.style.color = color; 
};

info.addTo(map);


//Supprime un élement du DOM
function remove(id) {
    return (elem=document.getElementById(id)).parentNode.removeChild(elem);
}

function correspondA(id){
	for(var i=0; i<correspondance.length; i++){
		var c = correspondance[i];
		if(c[1] === id)
			return c[0];
	}
}
// Évennement mouvement souri
document.onmousemove = getMouseXY;

// Applique à la tooltip la position de la souri
//(dans le cas ou la tooltip est affichée)
function getMouseXY(e) {
  
  tempX = e.clientX;
  tempY = e.clientY;

  // catch possible negative values in NS4
  if (tempX < 0){tempX = 0}
  if (tempY < 0){tempY = 0}  
  
  if(document.getElementById("tooltip") !== null){
    document.getElementById("tooltip").style.top = tempY + 10 + "px";
    document.getElementById("tooltip").style.left = tempX + 10 + "px";
  }
  
  return true;
}

//Affiche la tooltip
function displayTooltip(text){
  var body = document.getElementsByTagName("body")[0];
  
  var tooltip = document.createElement("div");
  tooltip.className = "tooltip";
  tooltip.id = "tooltip";
  tooltip.innerHTML = text;
  body.appendChild(tooltip);
}

//Cache la tooltip
function hideTooltip(){
  remove("tooltip");
}